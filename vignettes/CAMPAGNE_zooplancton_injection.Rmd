---
title: "Tutoriel pour injection des campagnes Zooplancton"
author: "Claire-Cécile Juhasz"
date: "10 novembre 2020"
output: html_document
---

## 1. Créer une base de données excel

Afin d'injecter des nouvelles campagnes *zooplancton* dans la base de données Coléo, vous devez regrouper les informations suivantes dans un fichier excel :

|Variable|Description                      |
|--------|--------------------------------------------------------------------------|
|*cell_code*|code numérique unique pour chaque cellule|
|*site_code*|code alpha-numérique unique du site|
|**type_hab**|type d'habitat dans lequel la campagne a été effectuée - `lac`, `rivière`, `forestier`, `marais`, `marais côtier`, `toundrique`, `tourbière`|
|*lat*|latitude du site d'échantillonnage|
|*lon*|longitude du site d'échantillonnage|
|*opened_at*|date du début du prélèvement|
|*closed_at*|date de la fin du prélèvement|
|**type**|type de la campagne, ici `zooplancton`|
|*technician_1*||
|*technician_2*||
|*depth*|profondeur du prélèvement en mètre|
|*taxa_name*|nom latin des espèces observées|
|*Date_denombrement*||
|*abondance*||
|*nom_lac*||
|*Taxonomiste*|
|||

Prenez soin de :

* vérifier **variables en gras** car elles possèdent des valeurs prédéfinies dans Coléo. Toutes les valeurs dans votre fichier doivent correspondre à une des valeurs possibles (vérifiez les majuscule, les accents ou d'éventuelles espaces inutiles).
* ne pas laisser de case vide. Inscrivez *NA* lorsque nécessaire.
* vérifier que votre fichier ne contienne que des nouvelles campagnes.
* vérifier l'encodage de votre fichier qui doit correspondre à "UTF-8".

```{r, child="etape2_to_7.Rmd"}
```

## 8. Injections des nouvelles campagnes de zooplanctons

Pour une injection complète d'une campagne, il est nécessaire de passer par l'importation d'informations successives dans différentes tables de Coléo. La hiérarchie des tables à renseigner est cruciale, sans quoi l'injection de la campagne est vouée à l'échec. Les prochaines étapes détaillent l'ajout d'information dans les tables:

1. Campagnes ("*/campaigns*")
2. Repères ("*/landmarks*")
3. Observations ("*/observations*")
4. Observations des espèces ("*/obs_species*")

### 8.1. Injections des informations sur les nouvelles campagnes

Les champs de la table **campagnes** ("/campaigns") de Coléo qui peuvent être remplis sont les suivants :

* *site_id*
* *type*
* *technicians* : liste composée de **technician_1** et **technicien_2**
* *opened_at*
* *closed_at*
* *notes* : correspond au nom du lac `nom_lac`

#### 8.1.1. On commence par séléctionner les champs d'interêts & on matche les noms de variables avec celles de Coléo.

```r
camp_camp <- dplyr::select(camp,
                           site_code,
                           type,
                           opened_at,
                           closed_at,
                           technician_1,
                           technician_2,
                           notes = nom_lac)
```
#### 8.1.2. On garde une ligne unique par nouvelle campagne.

```r
camp_camp <- camp_camp[!duplicated(camp_camp[c("site_code",
                                               "type",
                                               "opened_at")]),]
```

#### 8.1.3. On créé une liste pour le nom des technicien/ne/s.

```r
tech <- list() # Création d'un objet `list` vide

for(i in 1:length(camp_camp$site_code)){
  tech[[i]] <- list(camp_camp$technician_1[[i]], camp_camp$technician_2[[i]])
} # Chaque niveau de la liste correspond à une association des deux noms des technicien/ne/s pour chaque ligne du tableau

camp_camp$technicians <- tech # Ajout de la liste au tableau à injecter dans Coléo
```

#### 8.1.4. On tansforme le tableau en liste afin de pouvoir l'injecter dans Coléo.

```r
camp_ls <- apply(camp_camp, 1, as.list)
```
#### 8.1.5. Il est maintenant possible de procéder à l'injection.

```r
COLEO_camp_inj <- post_campaigns(camp_ls)
```
La sortie R vous informe sur le déroulement de l'insertion. Le message `Good job ! Toutes les insertions ont été créées dans COLEO` indique que les informations ont bien été enregistrées dans Coléo. Dans le cas inverse, le message `Oups... un problème est survenu` apparait, suivi des codes de statut pour chaque requête d'injections (pour plus d'informations à propos des [codes de statut](https://http.cat/)).

#### 8.1.7. On récupère la liste de campagnes provenant de Coléo.

```r
campaigns <- rcoleo::get_campaigns()
campaigns <- do.call(rbind.fill, campaigns[[1]]$body)
```
#### 8.1.8. On récupère le id unique pour chaque campagne nouvellement insérées.

```r
camp <- dplyr::left_join(camp, campaigns[, c("id", "site_id", "opened_at", "type")], by = c("site_id", "opened_at", "type"))
names(camp)[names(camp) == "id"] <- "campaign_id"

```

### 8.2. Injections des repères associés aux nouvelles campagnes

Les champs de la table **repères** ("/landmarks") de Coléo  qui seront remplis sont les suivants :

* *campaign_id*
* *geom* : créé à partir des variables "lat" & "lon"

#### 8.2.1. On commence par séléctionner les champs d'interêts & on matche les noms de variables avec celles de Coléo.

```r
land_camp <- dplyr::select(camp,
                           campaign_id,
                           lat,
                           lon)
```

#### 8.2.2. On garde une ligne par repère (c'est-à-dire par campagne).

```r
land_camp <- land_camp[!duplicated(land_camp),]
```

#### 8.2.3. On transforme le tableau en liste pour pouvoir l'injecter dans Coléo.

```r
land_ls <- apply(land_camp, 1, as.list)
```

#### 8.2.4. On créé le champs `geom` de Coléo, sous forme de liste, en utilisant les variables `lat` & `lon` du tableau.

```r
geom <- apply(land_camp, 1, function(x){
if(!any(is.na(x["lat"]),is.na(x["lon"]))){
  return(geojsonio::geojson_list(as.numeric(c(x["lon"],x["lat"])))$features[[1]]$geometry)
} else {
  return(NA)
}})
```

#### 8.2.5. On fusionne les deux listes en prévision de l'injection dans Coléo.

```r
for(i in 1:length(land_ls)){
 land_ls[[i]]$geom <- geom[i][[1]]
 if(is.list(land_ls[[i]]$geom)){
   land_ls[[i]]$geom$crs <- list(type = "name",
                                 properties = list(name = "EPSG:4326"))
 }
}
```

#### 8.2.6. Il est maintenant possible de procéder à l'injection.

```r
COLEO_land_inj <- post_landmarks(land_ls)
```

La sortie R vous informe sur le déroulement de l'insertion. Le message `Good job ! Toutes les insertions ont été créées dans COLEO` indique que les informations ont bien été enregistrées dans Coléo. Dans le cas inverse, le message `Oups... un problème est survenu` apparait, suivi des codes de statut pour chaque requête d'injections (pour plus d'informations à propos des [codes de statut](https://http.cat/)).

### 8.3. Injections des observations associées aux nouvelles campagnes

Les champs de la table **observations** ("/observations") de Coléo qui seront remplis sont les suivants :

* *date_obs*
* *is_valid* : 1 par défaut
* *campaign_id*
* *depth* : Profondeur_m
* *notes* : correspond aux variables `Date_denombrement` & `Taxonomiste`


#### 8.3.1. On séléctionne les champs d'interêts & on matche les noms de variables avec celles de Coléo.

```r
# Création de 2 variables nécessaires
camp$date_obs <- camp$opened_at
camp$is_valid <- 1 # valeur de 1 par défaut

# Sélection des champs d'intérêts
obs_camp <- dplyr::select(camp,
                          depth,
                          campaign_id,
                          date_obs,
                          is_valid)

# Création d'une dernière variable                          
obs_camp$notes <- paste0(camp_$Taxonomiste, "Date_denombrement", camp$Date_denombrement, sep = "-")

```

#### 8.3.2. On garde une ligne par campagne.

```r
obs_camp <- obs_camp[!duplicated(obs_camp),]
```

#### 8.3.3. On transforme le tableau en liste pour l'injection dans Coléo.

```r
obs_ls <- apply(obs_camp, 1, as.list)
```

#### 8.3.3. Il est maintenant possible de procéder à l'injection.

```r
COLEO_obs_inj <- post_observations(obs_ls)
```
La sortie R vous informe sur le déroulement de l'insertion. Le message `Good job ! Toutes les insertions ont été créées dans COLEO` indique que les informations ont bien été enregistrées dans Coléo. Dans le cas inverse, le message `Oups... un problème est survenu` apparait, suivi des codes de statut pour chaque requête d'injections (pour plus d'informations à propos des [codes de statut](https://http.cat/)).

#### 8.3.4 On récupère la liste des observations de Coléo et on met à jour le tableau de campagnes à injecter.

```r
# Acquisition de la liste des observations de Coléo
obs <- rcoleo::get_gen("/observations")
obs <- do.call(rbind.fill, obs$body)

# Mise à jour des données à injecter avec l'observation_id
camp <- dplyr::left_join(camp, obs[, c("id", "campaign_id", "date_obs")], by = c("campaign_id", "date_obs"))
names(camp)[names(camp) == "id"] <- "observation_id"
```

### 8.4. Injections de l'abondance des espèces associées aux nouvelles campagnes

Les champs de la table **observations des espèces** de Coléo qui peuvent être remplis sont les suivants :

* *taxa_name* : nom_scientifique
* *variable* : "abondance"
* *observation_id* 
* *value* : correspond à la variable `abondance`

#### 8.4.1. On séléctionne les champs d'interêts.

```r
obs_spe_camp <- dplyr::select(camp,
                              observation_id,
                              value = abondance,
                              taxa_name)
obs_spe_camp$variable <- "abondance"
```

#### 8.4.2. On transforme le jeu de données en liste pour l'injection dans Coléo.

```r
obs_spe_camp_ls <- apply(obs_spe_camp, 1, as.list)
```

#### 8.4.3. Il est maintenant possible de procéder à l'injection.

```r
COLEO_obsref_inj <- postpost_obs_species(obs_spe_camp_ls)

```
La sortie R vous informe sur le déroulement de l'insertion. Le message `Good job ! Toutes les insertions ont été créées dans COLEO` indique que les informations ont bien été enregistrées dans Coléo. Bravo ! Vous venez de terminer les étapes d'injections des campagnes **zooplancton** ! Dans le cas inverse, le message `Oups... un problème est survenu` apparait, suivi des codes de statut pour chaque requête d'injections (pour plus d'informations à propos des [codes de statut](https://http.cat/)).
