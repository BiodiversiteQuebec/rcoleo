---
title: "Importer les données depuis le fichier Excel du ministère"
author: "Steve Vissault"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```r

###########################
##### Injection Cellules ##
###########################

# Authentification
bearer <- readRDS(".httr-oauth")

# Match sur les champs de l'API
cells <- as.data.frame(unique(sites[,c("Nom_de_la_cellule","No_de_référence_de_la_cellule")]))
names(cells) <- c("name","cell_code")

# Ajouter les polygones de cellules
shp_cells <- readOGR(dsn="./extdata/shp/",layer="cellule_terrain_BdQc")

# Reprojection vers Quebec Lambert Conic
shp_cells <- sp::spTransform(shp_cells,CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs;"))

# Loop par dessus les noms de cellules pour aller chercher son polygon.
cells_ls <- list()

for(i in 1:nlevels(shp_cells$IJ)){

  cell_code <- levels(shp_cells$IJ)[i]
  shp <- shp_cells[shp_cells$IJ == cell_code ,]

  cells_ls[[i]] <- list()
  cells_ls[[i]]$cell_code <- cell_code
  cells_ls[[i]]$name <- shp_cells[shp_cells$IJ == cell_code ,]@data$Nom

  shp_sp <- as(shp, "SpatialPolygons")
  cells_ls[[i]]$geom <- geojson_list(shp)$features[[1]]$geometry

  # Add CRS fields
  cells_ls[[i]]$geom$crs <- list(type="name",properties=list(name="EPSG:4326"))

}

# Envoyer seulement les donnees avec un nom de cellule
resp_cells <- post_cells(cells_ls)

```
