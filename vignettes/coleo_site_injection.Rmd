---
title: "Injection des sites"
author: "Andrew MacDonald"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

the first step in injecting data in to the Coleo database is data validation (see vignette on data validation)

Once data is validated we can begin injection

## Injecting sites

In all campaigns, the first step is to confirm that all the sites are present. 

We begin by preparing the dataset for injection

```{r, include=FALSE}
library(httptest2)
start_vignette("coleo_site_injection")
```

Here is a demo dataset that we will use

```{r, include=TRUE}
insect_demo <- tibble::tribble(
    ~site_code, ~campaign_type, ~campaign_date_opened, ~campaign_date_closed, ~observation_date, ~observation_is_valid, ~trap_code, ~land_lat, ~land_lon, ~sample_code,                         ~campaign_technician_1, ~ref_taxa_rank, ~ref_taxa_tsn,          ~ref_taxa_name,  ~observation_taxa_name, ~observation_variable, ~observation_value, ~observation_notes,
  "102_90_F01", "insectes_sol",          "2020-06-02",          "2020-06-23",      "2020-06-23",                  TRUE,    "MP-11",  48.16126, -78.67106,  "2020-0083", "Isabelle_Dumais,Alexane_Gaudet,Annie_Hibbert",       "espèce",            NA,     "Cybaeopsis_euopla",     "Cybaeopsis_euopla",           "abondance",                  1,                 NA,
  "102_90_F01", "insectes_sol",          "2020-06-23",          "2020-07-14",      "2020-07-14",                  TRUE,    "MP-25",  48.16133, -78.67088,  "2020-0095", "Isabelle_Dumais,Alexane_Gaudet,Annie_Hibbert",       "espèce",            NA, "Bathyphantes_pallidus", "Bathyphantes_pallidus",           "abondance",                  1,                 NA
  )

```



```{r}
knitr::kable(insect_demo)
```

first we prepare it 

```{r}
insect_demo_site_prep <- rcoleo::coleo_prep_input_data(insect_demo, db_table = "sites")
```

Data preparation nests all the data which is not needed for injection into a particular table.
Here we are injecting data into the site table. these present data contain only the site_code.


```{r}

suppressPackageStartupMessages(library(tidyverse))
library(rcoleo)

site_id_results <- insect_demo_site_prep |> 
  mutate(site_id = coleo_get_site_id(site_code))

head(site_id_results)


```


the result is a dataframe with a column for site_id

This column has `NA_integer_` where the site needs to be injected.



### Workflow

* validate the whole dataset
* prepare the data for one table
* request IDs from the database
* if and only if the ID is absent, create a request to inject it (in a list col)
* check that these are formatted correctly by printing a few
* if and only if the ID is absent, inject that record, return response
* extract the ID code from that response
* combine ID codes from injection with those already there. Rename any columns. drop old columns. unnest the data nested in "prepare the data".









```{r, include=FALSE}
end_vignette()
```

